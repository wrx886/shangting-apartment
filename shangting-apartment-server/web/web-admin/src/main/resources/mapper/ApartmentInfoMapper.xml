<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
    namespace="com.github.wrx886.shangting_apartment_server.web.admin.mapper.ApartmentInfoMapper">

    <!-- 根据条件分页查询公寓列表 -->
    <select id="pageItem"
        resultType="com.github.wrx886.shangting_apartment_server.web.admin.vo.apartment.ApartmentItemVo">
        SELECT
            ai.id,
            ai.name,
            ai.introduction,
            ai.district_id,
            ai.district_name,
            ai.city_id,
            ai.city_name,
            ai.province_id,
            ai.province_name,
            ai.address_detail,
            ai.latitude,
            ai.longitude,
            ai.phone,
            ai.is_release,
            IFNULL(ri.cnt, 0) AS total_room_count,
            (IFNULL(ri.cnt, 0) - IFNULL(la.cnt, 0)) AS free_room_count
        FROM
            apartment_info AS ai
            LEFT JOIN (
                SELECT COUNT(*) AS cnt, apartment_id
                FROM room_info
                WHERE
                    is_release = 1
                    AND is_deleted = 0
                GROUP BY
                    apartment_id
            ) AS ri ON ai.id = ri.apartment_id
            LEFT JOIN (
                SELECT COUNT(*) AS cnt, apartment_id
                FROM lease_agreement
                WHERE
                    is_deleted = 0
                    AND status in (2, 5)
                GROUP BY
                    apartment_id
            ) AS la ON ai.id = la.apartment_id
        <where> 
            is_deleted = 0 
            <if test="queryVo.provinceId != null">
                AND province_id = #{queryVo.provinceId} 
            </if>
            <if test="queryVo.cityId != null">
                 AND city_id = #{queryVo.cityId} 
            </if>
            <if test="queryVo.districtId != null"> 
                AND district_id = #{queryVo.districtId} 
            </if>
        </where>
    </select>
    
</mapper>